<tool id="databases" name="miRNARetrieval " version="20.01">
    <!-- <description>aggregates annotated miRNAs provided by different miRNA databases</description> -->

    <command><![CDATA[
        #if $atype.grouptype == "overview":
            python ${__tool_directory__}/scripts/db_mining.py
                 --curpath ${__tool_directory__}
                --species $plant
                --database $atype.database
                --outfile $htmlreport1
                --outformat Rmarkdown
        #end if

        #if $atype.grouptype == "merge":
            bash ${__tool_directory__}/scripts/db_merging.sh
                --curpath ${__tool_directory__}
                --rnatype "miRNA"
                --species $plant
                #if $atype.mirbaseS.mirbase == "yes":
                    --mirbase "yes"
                    #if $atype.mirbaseS.change == "yes":
                        --mirbaseC "yes"
                    #end if
                #end if

                #if $atype.PmiRENS.PmiREN == "yes":
                    --PmiREN "yes"
                    #if $atype.PmiRENS.change == "yes":
                        --PmiRENC "yes"
                    #end if
                #end if
                #if $atype.sRNAannoS.sRNAanno == "yes":
                    --sRNAanno "yes"
                    #if $atype.sRNAannoS.change == "yes":
                        --sRNAannoC "yes"
                    #end if
                #end if

                #if $atype.PlantsmallRNAgenesS.PlantsmallRNAgenes == "yes":
                    --Pgenes "yes"
                    #if $atype.PlantsmallRNAgenesS.change == "yes":
                        --PgenesC "yes"
                    #end if
                #end if

                    --genome $genomefile

                --outxt $textout
                --rmd $htmlreport2
        #end if

    ]]></command>

    <inputs>
        <param name="plant" argument="--species" type="select" value="Choose" label="Select a species"
            help="The common plants were listed.">
            <options from_data_table="miRNA_species" >
                <filter type="sort_by" column="1"/>
                <validator type="no_options" message="No indexes are available for the selected input dataset"/>
            </options>
        </param>

        <conditional name="atype">
            <param name="grouptype" type="select" label="The content you want to analyze" help ="">
                <option value="overview" selected="true">Overview of four representative miRNA databases</option>
                <option value="merge">Aggregating already annotated miRNAs</option>
            </param>

            <when value="overview">
                <param name="database" label="sRNA databases" argument="--database" type="select" multiple="true" display="checkbox"
                    help ="">
                    <option value="miRBase" selected="true">miRBase</option>
                    <option value="PmiREN" selected="true">PmiREN</option>
                    <option value="sRNAanno" selected="true">sRNAanno</option>
                    <option value="PlantsmallRNAgenes" selected="true">PlantsmallRNAgenes</option>
                </param>
            </when>

            <when value="merge">
                <conditional name="mirbaseS">
                    <param name="mirbase" type="boolean" truevalue="yes" falsevalue="no"
                    checked="true" label="Include miRBase data?" />
                    <when value="yes">
                        <param name="change" type="boolean" truevalue="yes" falsevalue="no"
                    checked="false" label="Need to tranlate because of different genome versions?" />
                    </when>
                </conditional>

                <conditional name="PmiRENS">
                    <param name="PmiREN" type="boolean" truevalue="yes" falsevalue="no"
                    checked="true" label="Include PmiREN data?" />
                    <when value="yes">
                        <param name="change" type="boolean" truevalue="yes" falsevalue="no"
                    checked="false" label="Need to tranlate because of different genome versions?" />
                    </when>
                </conditional>

                <conditional name="sRNAannoS">
                    <param name="sRNAanno" type="boolean" truevalue="yes" falsevalue="no"
                    checked="true" label="Include sRNAanno data?" />
                    <when value="yes">
                        <param name="change" type="boolean" truevalue="yes" falsevalue="no"
                    checked="false" label="Need to tranlate because of different genome versions?" />
                    </when>
                </conditional>

                <conditional name="PlantsmallRNAgenesS">
                    <param name="PlantsmallRNAgenes" type="boolean" truevalue="yes" falsevalue="no"
                    checked="true" label="Include Plant small RNA genes data?" />
                    <when value="yes">
                        <param name="change" type="boolean" truevalue="yes" falsevalue="no"
                    checked="false" label="Need to tranlate because of different genome versions?" />
                    </when>
                </conditional>

                <param name="genomefile" type="data" format="simple" label="Input genome path" />

            </when>
        </conditional>
    </inputs>

    <stdio><exit_code range="1:" level="fatal" description="Error Running miRNARetrieval"/></stdio>

    <outputs>
        <data name="htmlreport1" format="html" label="The HTML report of databases from miRNARetrieval (overview)" >
            <filter>atype['grouptype'] == "overview"</filter>
        </data>
        <data name="textout" format="tsv" label="The merged file of databases from miRNARetrieval (merging)" >
            <filter>atype['grouptype'] == "merge"</filter>
        </data>        
        <data name="htmlreport2" format="html" label="The HTML report of databases from miRNARetrieval (merging)" >
            <filter>atype['grouptype'] == "merge"</filter>
        </data>
    </outputs>

<help>

|

.. class:: donemark

**What it does**

This tool is designed to:

    1. Integrating four representative miRNA databases (`miRBase`_, `PmiREN`_, `sRNAanno`_, and `Plant small RNA genes`_) into a unified HTML document containing miRNA family size, length distribution, and composition of the first base, enabling users performing comparative analysis easily.

    2. Aggregate already annotated miRNAs provided by four representative miRNA repositories.
    
        (Considering that the databases may come from different versions, the outputs can be unified by providing a genome and re-mapping using `GMAP`_)

.. class:: infomark

**Inputs**

For **Overview of four representative miRNA databases**:

- **sRNA databases**: select sRNA databases (at least one)

For **Aggregating already annotated miRNAs**:

- **sRNA databases**: select sRNA databases (at least one)
- **Input genome path**: a plain text containing the path of genome


.. class:: infomark

**Outputs**

For **Overview of four representative miRNA databases**:

- An HTML document recording the comprehensive information of miRNAs reported in selected databases.

For **Aggregating already annotated miRNAs**:

- An HTML document recording the merged miRNAs and the RNA secondary structure plot of miRNA precursors.


.. _`miRBase`: http://www.mirbase.org/
.. _`PmiREN`: http://www.pmiren.com/
.. _`sRNAanno`: http://plantsrnas.org/
.. _`Plant small RNA genes`: http://plantsmallrnagenes.science.psu.edu/
.. _`GMAP`: https://academic.oup.com/bioinformatics/article/21/9/1859/409207

|

    </help>

    <citations>
        <citation type="doi">10.1093/nar/gky1141</citation>
        <citation type="doi">10.1093/nar/gkz894</citation>
        <citation type="doi">10.1101/gr.256750.119</citation>
        <citation type="doi">10.1101/771121</citation>
        <citation type="doi">10.1093/bioinformatics/bti310</citation>
    </citations>

</tool>
